# Прецедент: «Торговать с другими игроками»

**Рамки.** Игра «Монополия» — процесс добровольного обмена активами (деньги, карты «Выход из тюрьмы», права собственности на недвижимость) между двумя игроками для взаимной стратегической выгоды. Прецедент охватывает инициацию предложения, переговоры, подтверждение условий и атомарное выполнение обмена.

**Уровень.** Пользовательская задача (игрок/ИИ): заключить сделку с другим участником игры.

**Основной исполнитель.** Игрок-инициатор (человек или ИИ).

**Второстепенный исполнитель.** Игрок-контрагент (человек или ИИ).

---

## Заинтересованные лица и их требования

*   **Игрок-инициатор (человек).** Хочет предложить сделку, ясно видеть свои и предлагаемые активы, вести переговоры, получить четкий ответ (принято/отклонено) и визуальное подтверждение обмена. Требует интуитивного интерфейса для составления предложения.
*   **Игрок-контрагент (человек).** Хочет ясно понять условия предложения, оценить его выгоду, иметь возможность отклонить, встречно предложить условия и получить подтверждение сделки.
*   **Игровой ИИ (компьютер).** Должен оценивать входящие предложения на основе стратегии (стоимость активов, полнота групп, текущий баланс) и автоматически принимать решения (принять/отклонить/контрпредложить). Также должен уметь сам инициировать реалистичные сделки.
*   **Система правил.** Требует валидации сделки: игроки не могут торговать заложенной недвижимостью без её выкупа, обмен должен быть симметричным (все активы меняют владельца атомарно), сделка не должна нарушать другие правила (например, количество домов).
*   **Разработчик.** Хочет обеспечить стабильность и безопасность процесса, особенно в сетевой игре: избежать состояний гонки, гарантировать атомарность транзакции, логировать все этапы для разрешения споров и воспроизведения состояния.

---

## Предусловия

1.  Игра запущена, сессия активна, и в ней участвуют как минимум два игрока.
2.  Ход не находится в активной фазе, запрещающей торги (например, сразу после броска кубиков до выполнения обязательных действий). *Торговля обычно разрешена в любое время между ходами.*
3.  Игрок-инициатор имеет как минимум один актив (деньги, карта, недвижимость) для предложения.
4.  Игрок-контрагент не является банкротом и активен в игре.
5.  Все активы, участвующие в сделке, существуют и их состояние актуально (недвижимость не заложена, карты находятся у игроков).
6.  Интерфейс торговли доступен и активен.

---

## Результаты (постусловия)

*   **Если сделка заключена:**
    *   Все указанные активы (деньги, карты, права на недвижимость) атомарно переданы между игроками.
    *   Балансы игроков обновлены.
    *   Владельцы недвижимости изменены в системе.
    *   Карты «Выход из тюрьмы» переданы из инвентаря одного игрока в инвентарь другого.
    *   Событие `TradeCompletedEvent` записано в лог с полными деталями сделки.
    *   UI обновлён: обновлены балансы, цвета полей, инвентари игроков.
*   **Если сделка отклонена или отменена:**
    *   Никакие изменения в состоянии игры не произведены.
    *   Событие `TradeDeclinedEvent` или `TradeCancelledEvent` записано в лог.
*   Состояние партии сохранено (при включённом авто-сохранении).

---

## Основной успешный сценарий

1.  Игрок-инициатор нажимает кнопку **«Предложить сделку»** в интерфейсе игры и выбирает игрока-контрагента из списка доступных.
2.  Система открывает **интерфейс составления предложения**. Интерфейс разделён на две части: «Я отдаю» и «Я получаю».
3.  Игрок-инициатор формирует предложение:
    *   В разделе «Я отдаю» он добавляет свои активы: деньги (ввод суммы), недвижимость (выбор из списка своих незаложенных свойств), карты «Выход из тюрьмы» (отмечает галочкой).
    *   В разделе «Я получаю» он добавляет активы, которые хочет получить от контрагента, аналогичным образом.
4.  Игрок-инициатор нажимает кнопку **«Предложить»**.
5.  Система выполняет **первичную проверку валидности** предложения (инициатор владеет тем, что предлагает, и т.д.). Если проверка не пройдена — показывается ошибка (см. Расширения).
6.  Игрок-контрагент получает уведомление о входящем предложении торговли. Он видит детализированное окно с предложением: что он получит и что он должен отдать.
7.  Игрок-контрагент оценивает предложение и нажимает кнопку **«Принять»**.
8.  Система выполняет **финальную проверку валидности** сделки (состояние активов не изменилось с момента предложения, оба игрока всё ещё в игре и т.д.).
9.  Если финальная проверка пройдена, система **атомарно выполняет обмен**:
    *   Списание и зачисление денег.
    *   Передача прав на недвижимость.
    *   Передача карт между инвентарями.
10. Система записывает в журнал событие `TradeCompletedEvent` с полными деталями.
11. Оба игрока получают визуальное подтверждение об успешной сделке: всплывающее уведомление, обновление балансов и списков активов.
12. Интерфейс торговли закрывается.

---

## Расширения / альтернативные потоки

### A. Контрагент отклоняет предложение

1.  На шаге 7 Основного сценария контрагент нажимает **«Отклонить»**.
2.  Игрок-инициатор получает уведомление «[Игрок] отклонил ваше предложение».
3.  Событие `TradeDeclinedEvent` записывается в лог.
4.  Никаких изменений в состоянии игры не происходит.

### B. Контрагент делает встречное предложение

1.  На шаге 7 Основного сценария контрагент нажимает **«Изменить предложение»**.
2.  Интерфейс торговли открывается для контрагента в режиме редактирования. Он может изменять обе части предложения (по сути, создавая новую сделку с roles reversed).
3.  Контрагент нажимает **«Отправить встречное предложение»**.
4.  Теперь исходный инициатор становится контрагентом и получает уведомление. Сценарий продолжается с шага 6, но роли игроков поменялись.

### C. Инициатор отменяет предложение до ответа

1.  После шага 4, но до шага 7, инициатор нажимает **«Отменить предложение»**.
2.  Контрагент, если уже видел предложение, получает уведомление «[Игрок] отозвал своё предложение».
3.  Событие `TradeCancelledEvent` записывается в лог.
4.  Никаких изменений в состоянии игры не происходит.

### D. Предложение невалидно (на этапе первичной проверки)

1.  На шаге 5 Основного сценария система обнаруживает ошибку (например, инициатор попытался предложить заложенную недвижимость).
2.  Показывается сообщение об ошибке с указанием причины: «Невозможно предложить заложенную недвижимость «Иллинойс Авеню». Сначала выкупите её.»
3.  Интерфейс торговли остаётся открытым, позволяя исправить предложение.

### E. Сделка невалидна (на этапе финальной проверки)

1.  На шаге 8 Основного сценария система обнаруживает, что состояние изменилось (например, один из активов был проданы банку или заложен в период между предложением и принятием).
2.  Сделка автоматически отменяется системой.
3.  Оба игрока получают уведомление: «Сделка не состоялась, так как активы изменились. Предложение устарело.»
4.  Событие `TradeFailedEvent` записывается в лог.

### F. Автоматическое решение (ИИ)

1.  Когда инициатор — ИИ, система на шагах 2-4 автоматически генерирует предложение на основе стратегии (например, попытка собрать цветовую группу, обмен неполных групп на деньги).
2.  Когда контрагент — ИИ, на шаге 7 система автоматически оценивает предложение (расчёт стоимости, стратегическая ценность) и принимает решение (Принять/Отклонить/Встречное предложение) без задержки, имитируя «размышление».

---

## Специальные требования

*   **Атомарность и согласованность.** Вся сделка должна выполняться как одна транзакция. Не должно быть ситуации, когда деньги списаны, но недвижимость не передана.
*   **Прозрачность и UI.** Интерфейс торговли должен быть максимально понятным, наглядно показывать итоговый баланс сделки для обеих сторон (например, «Вы получите: $500 + Парк Плейс; Вы отдадите: $200 + Карта «Выход из тюрьмы»).
*   **Логирование для аудита.** В лог должны записываться все детали: кто, с кем, что предложил, что запросил, когда было принято/отклонено. Это необходимо для разрешения споров и анализа игры.
*   **Сетевая синхронизация.** В многопользовательской игре сервер является арбитром. Все проверки и выполнения сделок должны происходить на сервере для предотвращения читерства.
*   **Валидация на стороне клиента и сервера.** Клиентский интерфейс должен предотвращать очевидно неверные действия (предложить не свои активы), но окончательная проверка всегда на сервере.

---

## Данные, с которыми работает игра

*   `TradeOffer`: `id`, `initiatorPlayerId`, `targetPlayerId`, `offeredAssets` (деньги, массив propertyId, массив cardIds), `requestedAssets`.
*   `Player`: `id`, `balance`, `properties[]`, `getOutOfJailCards[]`.
*   `Property`: `id`, `ownerId`, `isMortgaged`.
*   `GameEvent`: `TradeCompletedEvent`, `TradeDeclinedEvent`, `TradeCancelledEvent`.

---

## Вопросы, решаемые при настройке игры

1.  Можно ли торговать в любое время или только во время своего хода?
2.  Можно ли предлагать обмен, если у игрока нет денег, но есть недвижимость (обмен "актив на актив")?
3.  Как ИИ оценивает справедливость сделки? Какие параметры стратегии настраиваются (жадность, риск, желание собрать группу)?
4.  Нужно ли добавлять таймер на принятие решения для живых игроков в режиме реального времени?
5.  Можно ли предлагать сделки, в которых одна из сторон не отдаёт ничего (подарок)? Если да, то как это влияет на ИИ?