# Прецедент: «Применение карточки действия»

**Рамки.** Игра «Монополия» — действие использования карточки действия (карточки «Шанс» или «Общественная казна»), когда игрок попадает на соответствующую клетку поля или использует накопленную карточку из своего инвентаря. Охватывает вытягивание карточки, обработку действия (перемещение, получение/выплата денег, освобождение из тюрьмы и т.п.), обновление состояния игры и возврат карточки в колоду или сохранение у игрока.

**Уровень.** Задача, определённая пользователем (игрок/ИИ): применить действие карточки, вытянутой из колоды или имеющейся в инвентаре.

**Основной исполнитель.** Игрок (человек) — когда ходит человек;
(в варианте: Автомат / Игровой ИИ — когда ходит компьютер).

---

## Заинтересованные лица и их требования

* **Игрок (человек).** Хочет ясного и быстрого понимания эффекта карточки: увидеть текст карточки, немедленное применение действия (перемещение, получение денег, штраф и т.д.), обновление баланса и позиции на поле. Ожидает визуальной анимации и звуковых эффектов для улучшения игрового опыта.
* **Игровой ИИ (компьютер).** Должен автоматически применять эффект карточки согласно правилам, корректно обновлять своё состояние (баланс, позицию, инвентарь) и принимать решения в случае выбора (например, карточка с опциями).
* **Банк.** Должен обрабатывать денежные операции, связанные с карточкой: начислять или списывать средства, обновлять балансы игроков и банка.
* **Система правил.** Требует соблюдения правил применения карточек: корректного выполнения действий, возврата карточки в колоду или сохранения у игрока (карточки «Выход из тюрьмы»), обработки особых случаев (недостаточно средств для штрафа).
* **Разработчик.** Хочет модульной, расширяемой системы обработки карточек, возможности добавления новых типов карточек, корректного логирования действий и тестируемости всех сценариев.

---

## Предусловия

1. Игра запущена, сессия активна, и сейчас очередь для данного игрока.
2. Игрок либо остановился на клетке «Шанс» или «Общественная казна», либо активно использует карточку из инвентаря (например, карточку «Выход из тюрьмы»).
3. Колода карточек соответствующего типа доступна и содержит карточки (перемешана при необходимости).
4. Баланс игрока и состояние банка актуальны.
5. Интерфейс активен для отображения карточки и её эффекта.
6. Правила партии настроены (включены ли дополнительные эффекты, модификаторы сумм и т.п.).

---

## Результаты

* Если применение карточки успешно:
  * Действие карточки выполнено (игрок перемещён, деньги начислены/списаны, статус изменён).
  * Баланс игрока обновлён (при денежных операциях).
  * Позиция игрока на поле изменена (при перемещении).
  * Карточка возвращена в низ колоды или сохранена у игрока (для карточек «Выход из тюрьмы»).
  * Сгенерированы и записаны события: `CardDrawnEvent`, `ActionExecutedEvent`, `TransactionEvent` (при денежных операциях).
  * Интерфейс обновлён: показана карточка, анимация действия, обновлены баланс и позиция, доступные действия актуализированы.
* Если возникла ошибка (недостаточно средств для штрафа):
  * Игрок должен продать/заложить активы или объявить банкротство.
* В случае системной ошибки:
  * Откат изменений, сообщение об ошибке пользователю и запись в лог.

---

## Основной успешный сценарий

1. Игрок останавливается на клетке «Шанс» или «Общественная казна», либо выбирает действие «Использовать карточку» из инвентаря.
2. Система определяет тип карточки (Шанс/Общественная казна) и извлекает верхнюю карточку из соответствующей колоды.
3. Интерфейс отображает карточку с текстом действия и визуальными эффектами (анимация вытягивания карточки, звук).
4. Игрок видит описание действия карточки (например: «Переместитесь на Старт», «Получите 200$», «Заплатите штраф 50$», «Выйдите из тюрьмы бесплатно»).
5. Система анализирует тип действия карточки и подготавливает выполнение:
   * **Денежная операция** (получение/выплата): проверка баланса, подготовка транзакции.
   * **Перемещение**: расчёт новой позиции, проверка прохождения через старт.
   * **Изменение статуса**: выход из тюрьмы, получение права на освобождение.
   * **Специальное действие**: ремонт недвижимости, сбор с игроков и т.п.
6. Система выполняет действие:
   * При денежных операциях: Делает списание/начисление средств.
   * При перемещении: Измененяет позицию.
   * При изменении статуса: обновляет соответствующие флаги игрока.
7. Если карточка типа «Выход из тюрьмы» — система сохраняет её в инвентаре игрока. Иначе — возвращает карточку в низ колоды.
8. Интерфейс показывает результат применения карточки: обновлённый баланс, новую позицию на поле, анимацию перемещения (если применимо), подтверждающее сообщение.
9. Если действие карточки завершено — ход продолжается согласно правилам (игрок завершает ход или продолжает действия).
10. Игрок видит краткое сообщение о выполненном действии и при необходимости подсказки по следующему шагу.

---

## Расширения

### A. У игрока недостаточно средств для оплаты штрафа

1. При попытке списать штраф система обнаруживает недостаток средств.
2. Показать пользователю сообщение: «Недостаточно средств для оплаты штрафа».
3. Дать опции: `Продать/Заложить активы`, `Объявить банкротство`, `Взять кредит`.
4. Если игрок находит средства (продажа/залог) — повторить попытку списания.
5. Если игрок объявляет банкротство — система инициирует процедуру банкротства согласно правилам.

### B. Карточка требует сбора денег со всех игроков

1. Система определяет всех активных игроков в игре.
2. Для каждого игрока (кроме получателя):
   * Проверяет наличие средств для уплаты суммы.
   * Выполняет транзакцию.
3. Если у кого-то из игроков недостаточно средств — применяется расширение A для этого игрока.
4. Получатель получает сумму от всех игроков, его баланс обновляется.

### C. Карточка «Выход из тюрьмы»

1. Система определяет, что карточка должна быть сохранена у игрока.
2. Добавляет карточку в инвентарь игрока.
3. Интерфейс обновляет список карточек игрока, показывает иконку карточки в инвентаре.
4. Карточка не возвращается в колоду до момента её использования.
5. Когда игрок использует карточку (находясь в тюрьме):
   * Система освобождает игрока.
   * Удаляет карточку из инвентаря.
   * Возвращает карточку в низ колоды.

### D. Колода карточек пуста

1. Если все карточки розданы и колода пуста — система автоматически перемешивает использованные карточки (исключая карточки «Выход из тюрьмы» у игроков).
2. Формирует новую колоду и продолжает вытягивание.

### E. Автоматическое применение (ИИ)

1. Когда ходит ИИ, система автоматически вытягивает и применяет карточку.
2. Все действия выполняются аналогично основному сценарию, но без визуальной задержки для пользователя.
3. Результат применения логируется и отображается в истории ходов для наблюдения человеком-игроком.

## Специальные требования

* **Визуализация**: Анимация вытягивания и применения карточки должна быть плавной и информативной.
* **Доступность**: Текст карточки должен быть читаемым, с возможностью увеличения шрифта и озвучивания для игроков с ограниченными возможностями.
* **Локализация**: Тексты карточек должны поддерживать несколько языков.

---

## Вопросы

* Должны ли карточки иметь разные степени редкости или все карточки равновероятны?
* Нужна ли возможность отменить действие карточки (undo) в случае случайного подтверждения?
* Следует ли добавлять новые типы карточек в будущих версиях (кастомные карточки, события)?
* Как обрабатывать ситуацию, когда карточка требует действия, которое невозможно выполнить (например, ремонт при отсутствии домов)?
