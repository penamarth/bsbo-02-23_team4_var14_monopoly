# Прецедент: «Выйти из тюрьмы»

**Рамки.** Игра «Монополия» — действие выхода игрока или автомата из тюрьмы. Прецедент охватывает выбор способа выхода (оплата штрафа, использование карты «Выход из тюрьмы», бросок кубиков), применение правил игры и продолжение хода.

**Уровень.** Задача, определённая пользователем (игрок/ИИ): покинуть тюрьму и продолжить ход.

**Основной исполнитель.** Игрок (человек) — когда ходит человек;
(в варианте: Автомат / Игровой ИИ — когда ходит компьютер).

---

## Заинтересованные лица и их требования

* **Игрок (человек).** Хочет видеть доступные способы выхода, понимать последствия каждого выбора и получать визуальное подтверждение выхода и перемещения фишки.
* **Игровой ИИ (компьютер).** Должен автоматически выполнять действия выхода по правилам, корректно рассчитывать броски и применять правила для продолжения хода.
* **Система правил.** Требует точного контроля условий выхода: наличие карты, баланс для оплаты штрафа, количество попыток броска кубиков, обработка дублей.
* **Разработчик.** Хочет предсказуемой логики выхода, корректного логирования событий и наглядного отображения действий для игрока.

---

## Предусловия

1. Игра запущена и сессия активна.
2. Игрок находится в тюрьме.
3. У игрока есть допустимые способы выхода: штраф, карта «Выход из тюрьмы», возможность броска кубиков.
4. Состояние игры актуально: баланс, позиции фишек, собственность и правила партии.
5. Интерфейс/контроллеры активны: кнопки, меню выбора способа выхода, анимации кубиков.

---

## Результаты (постусловия)

* Игрок вышел из тюрьмы.
* Если выход был через бросок кубиков — фишка перемещена на количество клеток, равное сумме кубиков.
* Статус игрока обновлён, события зафиксированы в журнале.
* UI показывает актуальное положение игрока, баланс и доступные действия.
* Продолжается ход игрока или передаётся следующему участнику (по правилам).

---

## Основной успешный сценарий

1. Интерфейс уведомляет игрока о нахождении в тюрьме и возможности выбора способа выхода.

2. Игрок видит варианты:

   * Оплата штрафа
   * Использование карты «Выход из тюрьмы»
   * Бросок кубиков для попытки выбросить дубль

3. Игрок выбирает способ выхода:

   * **Штраф** — списание средств и освобождение.
   * **Карта** — использование карты и освобождение.
   * **Бросок кубиков** — выполняется анимация броска, отображаются значения кубиков:

     1. Если выпал дубль — освобождение и перемещение фишки на сумму кубиков.
     2. Если дубль не выпал — игрок остаётся в тюрьме, количество попыток уменьшается.
     3. После третьей неудачной попытки игрок обязан оплатить штраф и выходит.

4. UI обновляет состояние: фишка, баланс, подсказки о действиях.

5. Ход продолжается либо передаётся следующему игроку в соответствии с правилами.

---

## Расширения / альтернативные потоки

### A. Недостаточно средств для штрафа или нет карты

* Игрок обязан использовать бросок кубиков.
* Логика повторяется до трёх попыток; после третьей попытки списание происходит автоматически.

### B. Бросок кубиков неудачен

* Игрок остаётся в тюрьме.
* Ход передаётся следующему участнику.

### C. Дубль выпал в тюрьме

* Игрок освобождается и перемещается на сумму кубиков.
* Если это третий дубль подряд — учитываются правила партии (например, штраф или дальнейшие ограничения).

### D. Автоматическое решение (ИИ)

* ИИ выбирает оптимальный вариант выхода согласно стратегии: использовать карту, оплатить штраф или бросать кубики.
* Дальнейшие действия ИИ выполняются автоматически по основному сценарию.

---

## Специальные требования

* **Прозрачность действий.** Игрок видит варианты выхода и последствия.
* **История действий.** Все попытки выхода фиксируются в журнале.
* **Плавная анимация.** Движение фишки и броски кубиков сопровождаются анимацией, которую можно ускорить или отключить.
* **Настраиваемые правила.** Возможность изменять количество попыток, штрафы и обработку дублей.

---

## Используемые технологии (предложения)

* Генератор случайных чисел для броска кубиков.
* UI-анимации для броска кубиков и движения фишки.
* Логирование действий для аудита и воспроизведения ходов.
* Серверная проверка и атомарные операции при онлайн-игре.

---

## Данные, с которыми работает игра

* `player`: id, name, balance, inJail (boolean), jailCards (count)
* `dice`: dice1, dice2, sum, double (boolean)
* `gameState`: позиции фишек, баланс игроков, история ходов
* `settings`: правила партии (количество попыток, штрафы, обработка дублей)

---

## Вопросы, решаемые при настройке игры

1. Можно ли ускорить или пропустить анимацию броска кубиков?
2. Всегда ли после трёх неудачных попыток обязателен штраф?
3. Какие действия ИИ допустимы при наличии карты или недостатке средств?
4. Как обрабатывать дубль на третьей попытке в тюрьме?
5. Нужно ли показывать игроку подробные уведомления о каждом шаге выхода?
