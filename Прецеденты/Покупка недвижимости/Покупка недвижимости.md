# Прецедент: «Покупка недвижимости»

**Рамки.** Игра «Монополия» — действие покупки недвижимости игроком или автоматом, когда фишка игрока остановилась на незанятой покупаемой клетке (улица, железная дорога, коммунальное предприятие) и доступна опция приобретения. Охватывает предложение цены, оплату, смену владельца и возможный аукцион при отказе.

**Уровень.** Задача, определённая пользователем (игрок/ИИ): купить доступную недвижимость на своём ходу.

**Основной исполнитель.** Игрок (человек) — когда ходит человек;
(в варианте: Автомат / Игровой ИИ — когда ходит компьютер).

---

## Заинтересованные лица и их требования

* **Игрок (человек).** Хочет ясного, быстрого и прозрачного процесса покупки: увидеть цену, доступные опции (купить/отказаться), баланс до и после покупки, подтверждение транзакции и визуальное обновление собственности. Ожидает понятной информации о правах собственности и последующей аренде/улучшениях.
* **Игровой ИИ (компьютер).** Должен автоматически принимать решения о покупке на основе стратегии и правил, корректно списывать средства и получать право собственности.
* **Банк (система).** Должен проверить наличие средств, списать оплату, выдать сертификат права собственности и обновить денежную массу.
* **Система правил.** Требует соблюдения правил покупки (например: цена на карточке поля, аукцион при отказе, ограничения на покупку в тюрьме и т. п.).
* **Разработчик.** Хочет предсказуемой, тестируемой логики покупки, корректной записи транзакций в журнал, возможности конфигурации поведения (автоматический аукцион, подтверждение покупки и т.д.).

---

## Предусловия

1. Игра запущена, сессия активна, и сейчас очередь для данного игрока.
2. Фишка игрока остановилась на клетке, доступной для покупки (поле помечено как "доступно", без владельца).
3. Информация о цене и характеристиках поля загружена и доступна UI.
4. Баланс игрока и состояние банка актуальны.
5. Интерфейс/контроллеры активны (кнопка `Купить`, `Отказаться`, окно подтверждения).
6. Правила партии настроены (включён или выключен аукцион, автоматическое подтверждение и т.п.).

---

## Результаты (постусловия)

* Если покупка успешна:
  * С баланса покупателя списана цена покупки (`price`).
  * Владельцем поля становится покупатель; данные собственности обновлены (`owner`).
  * Сгенерированы и записаны события: `TransactionEvent`, `PropertyTransferEvent`.
  * UI обновлён: поле помечено цветом владельца, баланс игрока изменён, доступные действия обновлены (например, постройка домов).
* Если игрок отказался:
  * Запущен аукцион (если правило включено) или право покупки переходит к следующему игроку.
  * Зафиксирован `AuctionEvent` или `DeclineEvent`.
* В случае ошибки транзакции:
  * Откат изменений, сообщение об ошибке пользователю и запись в лог.
* Состояние партии сохранено после операции (при включённом авто‑сохранении).

---

## Основной успешный сценарий

1. Интерфейс сообщает игроку, что его фишка остановилась на покупаемой клетке и показывает карточку поля: название, цену, условие покупки, потенциальную аренду и возможные улучшения.
2. Игрок видит свои текущие деньги (баланс) и решение: `Купить` или `Отказаться` (возможно также `Предложить цену` в специальных режимах).
3. Игрок нажимает кнопку **`Купить`**.
4. Система проверяет предусловия: поле свободно, у игрока достаточно средств, нет блокировок на покупку (например, правило партии запрещает покупку в текущем режиме).
5. Если проверки прошли успешно — система списывает `price` с баланса игрока и резервирует средства (атомарная транзакция).
6. Система присваивает `owner = игрок` полю, обновляет метаданные поля (цвет, возможность строить) и отмечает поле как «принадлежит».
7. Система записывает события в журнал: `TransactionEvent {from: player, to: bank, amount: price}`, `PropertyAcquiredEvent {player, property}`.
8. UI показывает подтверждение покупки: баланс обновлён, поле окрашено под владельца, появляются кнопки для управления собственностью (строить дом/улучшать).
9. Если покупка завершена, ход продолжается согласно правилам (например, игрок завершил действие и ход переходит к следующему участнику или игрок продолжает, если по правилам он ещё должен совершить дополнительные действия).
10. Игрок видит краткое сообщение о завершении операции и при необходимости подсказки по следующему действию.

---

## Расширения / альтернативные потоки

### A. У игрока недостаточно средств

1. При выборе `Купить` система проверяет баланс и обнаруживает, что средств недостаточно.
2. Показать пользователю сообщение: «Недостаточно средств для покупки — требуется X, у вас Y».
3. Дать опции: `Продать/Заложить активы`, `Отказаться` (иницировать аукцион), `Взять кредит` (если правило разрешает).
4. Если игрок решает продать/заложить и средств становится достаточно — вернуться к шагу проверки покупки.
5. Если игрок отказывается — перейти к потоку аукциона или продолжить по правилу.

### B. Игрок отказался от покупки

1. При выборе `Отказаться` система отмечает, что первичная покупка пропущена.
2. Если правило партии требует — запускается аукцион: все игроки (включая того, кто отказался) могут делать ставки.
3. Если аукцион отключён — право покупки переходит к следующему игроку (поле остаётся незанятым).

### C. Конфликт при одновременной покупке (сетевая/многопользовательская)

1. Если два клиента одновременно пытаются купить одно поле (гонка):
   * Сервер определяет порядок обработки; одна транзакция успешна, другая отклонена.
   * Клиент, у которого транзакция отклонена, получает уведомление и обновление UI.
2. События транзакций логируются для отладки и восстановления.

### D. Ошибка при списании средств / база недоступна

1. Транзакция не выполнена — система откатывает все изменения.
2. Пользователю показывается сообщение о проблеме и предлагается повторить действие.
3. Пишется лог ошибки и создаётся запись для восстановления состояния.

### E. Автоматическое решение (ИИ)

1. Когда ходит ИИ, система вызывает стратегию принятия решения:
   * Если стратегия — покупать при наличии средств и при высокой ценности поля, выполняется покупка автоматически (тот же основной сценарий без UI подтверждения).
   * Иначе — отказаться и, при включённом аукционе, участвовать в торгах.

---

## Специальные требования

* **Атомарность транзакции.** Оплата и передача права собственности должны выполняться атомарно, чтобы избежать рассинхронизации (особенно в сети).
* **Понятные уведомления.** Пользователь должен видеть причину неудачи (недостаточно денег, поле уже куплено и т.п.).
* **Логирование и воспроизводимость.** Каждая покупка должна сохраняться с метаданными (время, игрок, цена, исход) для возможности аудита и отката.
* **Конфигурируемое поведение.** В настройках партии можно включать/выключать аукцион, автопокупку для ИИ, кредитование и т.п.
* **Доступность и UX.** Кнопки и модальные окна должны быть доступны пользователям с ограничениями (подсказки, крупный шрифт, клавиатурные команды).
* **Безопасность в мультиплеере.** Сервер — источник истины; клиенты не могут подделать транзакции покупки.

---

## Используемые технологии (предложения)

* Серверная проверка транзакций (REST / WebSocket API).
* Хранилище состояния партии (сквозная модель состояния на сервере, snapshot + event-log).
* Логирование событий (EventStore / журнал), чтобы воспроизводить ходы и транзакции.
* UI-модальные для подтверждения покупки и аукциона.
* Механизм атомарных операций/транзакций в БД (или механизмы блокировки ресурсов).

---

## Данные, с которыми работает игра

* `property`: id, name, price, owner (nullable), houseLevel, mortgageStatus.
* `player`: id, name, balance, assets.
* `transaction`: id, from, to, amount, timestamp, reason.
* `auction`: propertyId, bids[], status.
* `gameState`: snapshot до/после операции, журнал событий.
* `settings`: rules (auctionEnabled, allowCredit, AI_buyThreshold).

---

## Вопросы, решаемые при настройке игры

1. Всегда ли при отказе запускается аукцион, или это опция партии?
2. Нужно ли разрешать автопокупку для ИИ и при каких условиях?
3. Поддерживаем ли кредиты/заём у банка для покупки?
4. Как обрабатывать одновременные покупки в сетевой игре — приоритет клиента или сервер?
5. Необходимо ли подтверждение покупки для игрока или отключаем в «быстром» режиме?
6. Какие ограничения есть для покупки (например, нельзя покупать в тюрьме)?

---